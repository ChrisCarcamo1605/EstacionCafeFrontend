---
export const prerender = false;
import Navbar from "../../../components/Navbar.astro";
import Layout from "../../../layouts/Layout.astro";
import LeftBar from "../../../components/LeftBar.astro";

const options: string[] = ["General", "Alertas"];

const ajustesRouteMap: Record<string, string> = {
    "General": "/administracion/ajustes/ajustes-general",
    "Alertas": "/administracion/ajustes/ajustes-alerta"
};

// Obtener configuración actual del servidor de alertas
let alertConfig = {
  alertEmail: "vanegaschristopher1@gmail.com",
  thresholdPercentage: 25,
  checkIntervalHours: 24
};

try {
  const response = await fetch('http://localhost:3004/api/alert-config');
  if (response.ok) {
    const data = await response.json();
    alertConfig = data.config;
  }
} catch (error) {
  console.error('Error cargando configuración de alertas:', error);
}
---

<!-- Importar fuente Roboto -->
<link
  href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
  rel="stylesheet"
/>

<Layout title="Ajustes Alerta">
  <Navbar />

  <div class="container-fluid d-flex m-0 p-0">
    <LeftBar title="Ajustes" options={options} selectedOption="Alertas" routeMap={ajustesRouteMap} />

    <div
      class="col-md-10 bg-white p-0 h-100"
      style="font-family: 'Roboto', sans-serif;"
    >
      <div class="h-100 d-flex flex-column">
        <div class="card border-0 shadow-sm h-100 rounded-3">
          <div class="card-header bg-white border-0 py-2 px-3">
            <h1 class="h3 fw-semibold mb-4">Alertas</h1>
          </div>

          <!-- Ajuste del padding izquierdo reducido -->
          <div class="card-body py-3 px-4">
            
            <!-- Mensaje de estado -->
            <div id="alertMessage" class="alert d-none mb-3" role="alert"></div>

            <!-- Campo de correo -->
            <div class="mb-3">
              <label class="form-label small fw-bold mb-1"
                >Correo para alertas de inventario</label
              >
              <input
                id="email-input"
                type="email"
                class="form-control form-control-sm shadow-sm border-light"
                placeholder="correo@ejemplo.com"
                style="max-width: 400px;"
                value={alertConfig.alertEmail}
              />
              <small class="text-muted">Este correo recibirá las alertas automáticas de stock bajo</small>
            </div>

            <!-- Campo porcentaje umbral -->
            <div class="mb-3">
              <label class="form-label small fw-bold mb-1"
                >Umbral de cantidad para alertas</label
              >
              <div class="d-flex align-items-center gap-2">
                <input
                  id="threshold-input"
                  type="number"
                  class="form-control form-control-sm shadow-sm border-light"
                  style="max-width: 100px;"
                  min="1"
                  max="100"
                  value={alertConfig.thresholdPercentage}
                />
                <span class="text-muted small">unidades</span>
              </div>
              <small class="text-muted">Se enviará alerta cuando la cantidad sea menor o igual a este valor</small>
            </div>

            <!-- Campo horas entre verificaciones -->
            <div class="mb-4">
              <label class="form-label small fw-bold mb-1"
                >Frecuencia de verificación automática</label
              >
              <div class="d-flex align-items-center gap-2">
                <input
                  id="interval-input"
                  type="number"
                  class="form-control form-control-sm shadow-sm border-light"
                  style="max-width: 100px;"
                  min="1"
                  max="168"
                  value={alertConfig.checkIntervalHours}
                />
                <span class="text-muted small">horas</span>
              </div>
              <small class="text-muted">El sistema verifica automáticamente cada día a las 8:00 AM</small>
            </div>

            <!-- Información del sistema -->
            <div class="alert alert-info border-0 shadow-sm mb-3" style="font-size: 0.85rem;">
              <strong>Información:</strong>
              <ul class="mb-0 mt-2" style="font-size: 0.8rem;">
                <li>Las alertas se envían automáticamente por correo cuando se detecta stock bajo</li>
                <li>El correo incluye tablas detalladas de consumibles e ingredientes con stock crítico</li>
                <li>Verificación automática configurada para ejecutarse diariamente</li>
                <li>Puedes forzar una verificación manual con el botón de abajo</li>
              </ul>
            </div>

            <!-- Botones de acción -->
            <div class="d-flex gap-2">
              <button
                id="saveConfigBtn"
                type="button"
                class="btn btn-sm fw-bold shadow-sm rounded-3 px-3 py-1"
                style="background-color: #482E21; border-color: #482E21; color: white; font-size: 0.8rem;"
              >
                Guardar Configuración
              </button>
              
              <button
                id="checkNowBtn"
                type="button"
                class="btn btn-sm fw-bold shadow-sm rounded-3 px-3 py-1"
                style="background-color: #F3DCBB; border-color: #F3DCBB; color: #000; font-size: 0.8rem;"
              >
                Verificar Ahora
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const emailInput = document.getElementById('email-input') as HTMLInputElement;
    const thresholdInput = document.getElementById('threshold-input') as HTMLInputElement;
    const intervalInput = document.getElementById('interval-input') as HTMLInputElement;
    const saveConfigBtn = document.getElementById('saveConfigBtn') as HTMLButtonElement;
    const checkNowBtn = document.getElementById('checkNowBtn') as HTMLButtonElement;
    const alertMessage = document.getElementById('alertMessage') as HTMLDivElement;

    const API_BASE_URL = 'http://localhost:3004/api';

    // Función para mostrar mensajes
    function showMessage(message: string, type: 'success' | 'error' | 'info') {
      if (!alertMessage) return;
      
      alertMessage.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} mb-3`;
      alertMessage.textContent = message;
      alertMessage.classList.remove('d-none');
      
      setTimeout(() => {
        alertMessage.classList.add('d-none');
      }, 5000);
    }

    // Guardar configuración
    async function saveConfiguration() {
      if (!emailInput || !thresholdInput || !intervalInput) return;

      const email = emailInput.value.trim();
      const threshold = parseInt(thresholdInput.value);
      const interval = parseInt(intervalInput.value);

      // Validaciones
      if (!email) {
        showMessage('Por favor ingrese un correo electrónico', 'error');
        return;
      }

      if (!email.includes('@')) {
        showMessage('Por favor ingrese un correo válido', 'error');
        return;
      }

      if (threshold < 1 || threshold > 100) {
        showMessage('El umbral debe estar entre 1 y 100', 'error');
        return;
      }

      if (interval < 1 || interval > 168) {
        showMessage('El intervalo debe estar entre 1 y 168 horas', 'error');
        return;
      }

      try {
        if (saveConfigBtn) saveConfigBtn.disabled = true;

        const response = await fetch(`${API_BASE_URL}/alert-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            alertEmail: email,
            thresholdPercentage: threshold,
            checkIntervalHours: interval
          })
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('Configuración guardada exitosamente. Reinicie el servidor de alertas para aplicar cambios.', 'success');
          console.log('Configuración actualizada:', data.config);
        } else {
          showMessage(`Error: ${data.error || 'No se pudo guardar la configuración'}`, 'error');
        }

      } catch (error) {
        console.error('Error guardando configuración:', error);
        showMessage('Error de conexión. Verifique que el servidor de alertas esté ejecutándose en http://localhost:3004', 'error');
      } finally {
        if (saveConfigBtn) saveConfigBtn.disabled = false;
      }
    }

    // Verificar inventario ahora
    async function checkInventoryNow() {
      if (!checkNowBtn) return;

      try {
        checkNowBtn.disabled = true;
        checkNowBtn.textContent = 'Verificando...';

        const response = await fetch(`${API_BASE_URL}/check-inventory`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('Verificación completada. Si hay alertas, se enviará un correo. Revisa la consola del servidor para más detalles.', 'success');
        } else {
          showMessage(`Error: ${data.error || 'No se pudo realizar la verificación'}`, 'error');
        }

      } catch (error) {
        console.error('Error verificando inventario:', error);
        showMessage('Error de conexión. Verifique que el servidor de alertas esté ejecutándose en http://localhost:3004', 'error');
      } finally {
        if (checkNowBtn) {
          checkNowBtn.disabled = false;
          checkNowBtn.textContent = 'Verificar Ahora';
        }
      }
    }

    // Event listeners
    if (saveConfigBtn) {
      saveConfigBtn.addEventListener('click', saveConfiguration);
    }

    if (checkNowBtn) {
      checkNowBtn.addEventListener('click', checkInventoryNow);
    }

    console.log('Sistema de configuración de alertas inicializado');
  });
</script>