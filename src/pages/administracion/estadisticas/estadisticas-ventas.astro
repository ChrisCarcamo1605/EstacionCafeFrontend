---
export const prerender = false;
import Layout from "../../../layouts/Layout.astro";
import LeftSidebar from "../../../components/LeftBar.astro";
import Navbar from "../../../components/Navbar.astro";
import ApexCharts from "apexcharts";
import {BACKEND_API_URL, ML_API_URL} from '../../../config/api'

const estadisticasRouteMap: Record<string, string> = {
    "Estadisticas de Ventas": "/administracion/estadisticas/estadisticas-ventas",
    "Estadisticas de Gastos": "/administracion/estadisticas/estadisticas-gastos",
    "Reporte de Ventas": "/administracion/estadisticas/reporte-ventas"
};

const response = await fetch(`${ML_API_URL}/sales-data`, {
    method: "GET",
    headers: {
        "Content-Type": "application/json",
    },
});

const response1 = await fetch(`${BACKEND_API_URL}/bills`,{
    method: "GET",
    headers:{
      "Content-Type": "application/json",
    },
});

let json1 = null;
if (response1.ok) {
    json1 = await response1.json();
} else {
}


let json = null;
if (response.ok) {
    json = await response.json();
} else {
    console.error("Error fetching data:", response.statusText);
}

const productosMasRentables = json.analisis_productos
    .sort((a: any, b: any) => b.rentabilidad - a.rentabilidad)
    .slice(0, 7);
---

<Layout title="Estadisticas de Ventas">
    <!-- Navbar en la parte superior -->
    <Navbar />
    
    <div class="d-flex">
        <LeftSidebar 
            title="Resumen" 
            options={["Estadisticas de Ventas", "Estadisticas de Gastos", "Reporte de Ventas"]}
            selectedOption="Estadisticas de Ventas"
            routeMap={estadisticasRouteMap}
        />
        <div class="flex-grow-1 p-4">
            <div class="row">
                <div class="col-md-9">
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header text-white text-center py-2" style="background-color: #482E21;">
                                    <h5 class="mb-0">7 Productos MÃ¡s Rentables</h5>
                                </div>
                                <div class="card-body p-3">
                                    <div id="productos-chart"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header text-white text-center py-2" style="background-color: #482E21;">
                                    <h5 class="mb-0">Secuencia de Ventas</h5>
                                </div>
                                <div class="card-body p-3">
                                    <div id="area-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <br/>
                    <div class="mt-5">
                        <div class="card shadow-sm border-0" style="border-radius: 8px;">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead style="background-color: #482E21; color: white;">
                                            <tr>
                                                <th scope="col">Producto</th>
                                                <th scope="col">Unidades Vendidas</th>
                                                <th scope="col">Ingresos Totales</th>
                                                <th scope="col">Rentabilidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {json.analisis_productos.map((analisis_productos: any) => (
                                                <tr>
                                                    <th scope="row">{analisis_productos.producto}</th>
                                                    <td>{analisis_productos.unidades_vendidas}</td>
                                                    <td>{analisis_productos.ingresos_totales}</td>
                                                    <td>{analisis_productos.rentabilidad}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div 
                        id="chart-data" 
                        data-productos={JSON.stringify(productosMasRentables.map((p: any) => p.producto))}
                        data-rentabilidades={JSON.stringify(productosMasRentables.map((p: any) => p.rentabilidad))}
                        style="display: none;"
                    ></div>
                    <div 
                        id="area-data" 
                        data-ventas={JSON.stringify(json1.data.map((item: any) => parseFloat(item.total)))}
                        style="display: none;"
                    ></div>
                </div>
                
                <div class="col-md-3">
                    <div class="sticky-top" style="top: 20px;">
                        <h5 class="mb-3 text-center" style="color: #482E21;">Predicciones</h5>
                        <div class="d-flex flex-column gap-3">
                            {json.predicciones.map((prediccion: any) => (
                                <div class="card shadow-sm" style="max-width: 100%;">
                                    <div class="card-header text-white py-1 px-2 text-center" style="background-color: #482E21;">
                                        <strong class="fs-7">{prediccion.fecha}</strong>
                                    </div>
                                    <div class="card-body py-2 px-2 text-center">
                                        <h6 class="card-title fw-bold mb-1" style="color: #482E21;">
                                            {prediccion.prediccion}<span>$</span>
                                        </h6>
                                        <p class="card-text mb-0 fs-8 text-muted">
                                            {prediccion.dia_semana}
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</Layout>

<style>
    .table th {
        font-weight: 600;
        font-size: 0.875rem;
        padding: 12px 16px;
    }

    .table td {
        padding: 12px 16px;
        vertical-align: middle;
    }

    .card {
        border-radius: 8px;
    }

    .fs-7 {
        font-size: 0.8rem !important;
    }
    
    .fs-8 {
        font-size: 0.75rem !important;
    }

    #productos-chart, #area-chart {
        height: 300px !important;
    }

    .table tbody tr {
        background-color: white;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    [class*="sidebar"] [class*="item"],
    [class*="nav"] [class*="link"],
    [class*="list"] [class*="item"] {
        transition: background-color 0.2s ease;
    }

    [data-nav-configured="true"] {
        cursor: pointer !important;
    }

    [data-nav-configured="true"]:hover {
        background-color: #f8f9fa !important;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const chartDataElement = document.getElementById('chart-data');
        
        if (chartDataElement) {
            const productosData = chartDataElement.dataset.productos;
            const rentabilidadesData = chartDataElement.dataset.rentabilidades;

            if (productosData && rentabilidadesData) {
                const productos = JSON.parse(productosData);
                const rentabilidades = JSON.parse(rentabilidadesData);

                var productosOptions = {
                  series: [{
                  name: 'Rentabilidad',
                  data: rentabilidades
                }],
                  chart: {
                  height: 300,
                  type: 'bar',
                },
                colors: ['#482E21'],
                plotOptions: {
                  bar: {
                    borderRadius: 8,
                    dataLabels: {
                      position: 'top',
                    },
                  }
                },
                dataLabels: {
                  enabled: true,
                  formatter: function (val: number) {
                    return val.toFixed(1) + "%";
                  },
                  offsetY: -15,
                  style: {
                    fontSize: '10px',
                    colors: ['#482E21']
                  }
                },
                xaxis: {
                  categories: productos,
                  labels: {
                    rotate: -45,
                    style: {
                        fontSize: '10px',
                        fontFamily: 'Roboto, sans-serif'
                    }
                  }
                },
                yaxis: {
                  labels: {
                    show: false,
                  }
                },
                grid: {
                  padding: {
                    top: 30,
                    bottom: 10
                  }
                }
                };

                var productosChart = new ApexCharts(document.querySelector("#productos-chart"), productosOptions);
                productosChart.render();
            }
        }

        const areaDataElement = document.getElementById('area-data');
        
        if (areaDataElement) {
            const ventasData = areaDataElement.dataset.ventas;

            if (ventasData) {
                const montosVenta = JSON.parse(ventasData);
                
                const secuenciaVentas = montosVenta.map((monto: any, index: number) => index + 1);
                
                var areaOptions = {
                  series: [{
                    name: 'Monto de Venta',
                    data: montosVenta
                  }],
                  chart: {
                    type: 'area',
                    stacked: false,
                    height: 300,
                    zoom: {
                      enabled: false
                    },
                    toolbar: {
                      show: false
                    }
                  },
                  colors: ['#8B4513'],
                  dataLabels: {
                    enabled: false
                  },
                  markers: {
                    size: 3,
                    colors: ['#8B4513'],
                    strokeColors: '#fff',
                    strokeWidth: 1,
                  },
                  fill: {
                    type: 'gradient',
                    gradient: {
                      shadeIntensity: 1,
                      inverseColors: false,
                      opacityFrom: 0.6,
                      opacityTo: 0.2,
                      stops: [0, 90, 100]
                    },
                  },
                  yaxis: {
                    labels: {
                      formatter: function (val: number) {
                        return '$' + val.toFixed(0);
                      },
                      style: {
                        fontSize: '10px'
                      }
                    },
                  },
                  xaxis: {
                    tickAmount: 5,
                    labels: {
                      style: {
                        fontSize: '10px'
                      }
                    }
                  },
                  tooltip: {
                    shared: false,
                    y: {
                      formatter: function (val: number) {
                        return '$' + val.toFixed(2);
                      }
                    },
                    x: {
                      formatter: function (val: string) {
                        return 'Venta #' + val;
                      }
                    }
                  },
                  grid: {
                    borderColor: '#e7e7e7',
                    padding: {
                      top: 10,
                      bottom: 10
                    }
                  }
                };

                var areaChart = new ApexCharts(document.querySelector("#area-chart"), areaOptions);
                areaChart.render();
            }
        }
    });
</script>