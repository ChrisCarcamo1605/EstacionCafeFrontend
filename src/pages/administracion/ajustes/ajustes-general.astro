---
export const prerender = false;
import Navbar from "../../../components/Navbar.astro";
import Layout from "../../../layouts/Layout.astro";
import LeftBar from "../../../components/LeftBar.astro";

const options = ["General", "Alertas"];

const ajustesRouteMap: Record<string, string> = {
    "General": "/administracion/ajustes/ajustes-general",
    "Alertas": "/administracion/ajustes/ajustes-alerta"
};
---

<!-- Importar íconos de Bootstrap -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  rel="stylesheet"
/>

<!-- Importar fuente Roboto -->
<link
  href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
  rel="stylesheet"
/>

<Layout title="Ajustes General">
  <Navbar />

  <div class="container-fluid d-flex m-0 p-0">
    <LeftBar title="Ajustes" options={options} selectedOption="General" routeMap={ajustesRouteMap} />

    <div class="col-md-10 bg-white p-0 h-100" style="font-family: 'Roboto', sans-serif;">
      <div class="h-100 d-flex flex-column">
        <div class="card border-0 shadow-sm h-100 rounded-3">
          <div class="card-header bg-white border-0 py-2 px-3">
            <h1 class="h3 fw-semibold mb-4">General</h1>
          </div>

          <div class="card-body py-3 px-4">
            <!-- Mensaje de estado -->
            <div id="statusMessage" class="alert d-none mb-3" role="alert"></div>

            <!-- Tema de interfaz -->
            <div class="mb-3 position-relative">
              <label class="form-label small fw-bold mb-1">Tema de interfaz</label>
              <div
                id="themeDropdown"
                class="dropdown-custom d-flex align-items-center justify-content-between px-2 py-1 bg-white border shadow-sm rounded-2"
                style="width: 150px; cursor: pointer; font-size: 0.8rem;"
                tabindex="0"
              >
                <span id="themeValue" class="text-start fw-normal">Claro</span>
                <i class="bi bi-chevron-down text-muted" style="font-size: 0.8rem;"></i>
              </div>
              <div id="themeMenu" class="dropdown-menu-custom shadow-sm d-none" style="width: 150px;">
                <div class="dropdown-item-custom" data-value="light">Claro</div>
                <div class="dropdown-item-custom" data-value="dark">Oscuro</div>
              </div>
            </div>

            <!-- Moneda -->
            <div class="mb-4 position-relative">
              <label class="form-label small fw-bold mb-1">Moneda</label>
              <div
                id="currencyDropdown"
                class="dropdown-custom d-flex align-items-center justify-content-between px-2 py-1 bg-white border shadow-sm rounded-2"
                style="width: 190px; cursor: pointer; font-size: 0.8rem;"
                tabindex="0"
              >
                <span id="currencyValue" class="text-start fw-normal">Dólar estadounidense</span>
                <i class="bi bi-chevron-down text-muted" style="font-size: 0.8rem;"></i>
              </div>
              <div id="currencyMenu" class="dropdown-menu-custom shadow-sm d-none" style="width: 190px;">
                <div class="dropdown-item-custom" data-value="USD">Dólar estadounidense</div>
                <div class="dropdown-item-custom" data-value="EUR">Euro</div>
                <div class="dropdown-item-custom" data-value="MXN">Peso mexicano</div>
                <div class="dropdown-item-custom" data-value="COP">Peso colombiano</div>
                <div class="dropdown-item-custom" data-value="ARS">Peso argentino</div>
              </div>
            </div>

            <!-- Información de configuración -->
            <div class="alert alert-info border-0 shadow-sm mb-3" style="font-size: 0.85rem;">
              <strong>Información:</strong>
              <ul class="mb-0 mt-2" style="font-size: 0.8rem;">
                <li>Las preferencias se guardan en el navegador (localStorage)</li>
                <li>El tema oscuro será implementado en una futura actualización</li>
                <li>La moneda seleccionada se aplicará en toda la aplicación</li>
              </ul>
            </div>

            <!-- Botones de acción -->
            <div class="d-flex gap-2">
              <button
                id="saveSettingsBtn"
                type="button"
                class="btn btn-sm fw-bold shadow-sm rounded-3 px-3 py-1"
                style="background-color: #482E21; border-color: #482E21; color: white; font-size: 0.8rem;"
              >
                Guardar Cambios
              </button>
              
              <button
                id="resetSettingsBtn"
                type="button"
                class="btn btn-sm fw-bold shadow-sm rounded-3 px-3 py-1"
                style="background-color: #E6E6E6; border-color: #E6E6E6; color: #000; font-size: 0.8rem;"
              >
                Restaurar Predeterminados
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .dropdown-menu-custom {
    position: absolute;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-top: 2px;
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
  }

  .dropdown-item-custom {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.15s ease;
  }

  .dropdown-item-custom:hover {
    background-color: #f8f9fa;
  }

  .dropdown-item-custom.active {
    background-color: #482E21;
    color: white;
  }

  .dropdown-custom:focus {
    outline: 2px solid #482E21;
    outline-offset: 2px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const themeDropdown = document.getElementById('themeDropdown') as HTMLDivElement;
    const themeValue = document.getElementById('themeValue') as HTMLSpanElement;
    const themeMenu = document.getElementById('themeMenu') as HTMLDivElement;
    
    const currencyDropdown = document.getElementById('currencyDropdown') as HTMLDivElement;
    const currencyValue = document.getElementById('currencyValue') as HTMLSpanElement;
    const currencyMenu = document.getElementById('currencyMenu') as HTMLDivElement;
    
    const saveSettingsBtn = document.getElementById('saveSettingsBtn') as HTMLButtonElement;
    const resetSettingsBtn = document.getElementById('resetSettingsBtn') as HTMLButtonElement;
    const statusMessage = document.getElementById('statusMessage') as HTMLDivElement;

    // Configuración por defecto
    const defaultSettings = {
      theme: 'light',
      currency: 'USD'
    };

    // Mapeo de valores a textos
    const themeLabels: Record<string, string> = {
      light: 'Claro',
      dark: 'Oscuro'
    };

    const currencyLabels: Record<string, string> = {
      USD: 'Dólar estadounidense',
      EUR: 'Euro',
      MXN: 'Peso mexicano',
      COP: 'Peso colombiano',
      ARS: 'Peso argentino'
    };

    // Estado actual
    let currentSettings = {
      theme: 'light',
      currency: 'USD'
    };

    // Cargar configuración guardada
    function loadSettings() {
      try {
        const saved = localStorage.getItem('generalSettings');
        if (saved) {
          currentSettings = JSON.parse(saved);
        }
        updateUI();
      } catch (error) {
        console.error('Error cargando configuración:', error);
        currentSettings = { ...defaultSettings };
        updateUI();
      }
    }

    // Actualizar UI con valores actuales
    function updateUI() {
      themeValue.textContent = themeLabels[currentSettings.theme] || 'Claro';
      currencyValue.textContent = currencyLabels[currentSettings.currency] || 'Dólar estadounidense';
      
      // Marcar items activos
      updateActiveItems();
    }

    // Actualizar items activos en los menús
    function updateActiveItems() {
      document.querySelectorAll('#themeMenu .dropdown-item-custom').forEach(item => {
        const value = (item as HTMLElement).dataset.value;
        if (value === currentSettings.theme) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      document.querySelectorAll('#currencyMenu .dropdown-item-custom').forEach(item => {
        const value = (item as HTMLElement).dataset.value;
        if (value === currentSettings.currency) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    // Mostrar mensaje
    function showMessage(message: string, type: 'success' | 'error' | 'info') {
      if (!statusMessage) return;
      
      statusMessage.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} mb-3`;
      statusMessage.textContent = message;
      statusMessage.classList.remove('d-none');
      
      setTimeout(() => {
        statusMessage.classList.add('d-none');
      }, 4000);
    }

    // Toggle dropdown
    function toggleDropdown(menu: HTMLElement) {
      const isVisible = !menu.classList.contains('d-none');
      
      // Cerrar todos los dropdowns
      document.querySelectorAll('.dropdown-menu-custom').forEach(m => {
        m.classList.add('d-none');
      });
      
      // Toggle el actual
      if (!isVisible) {
        menu.classList.remove('d-none');
      }
    }

    // Guardar configuración
    function saveSettings() {
      try {
        localStorage.setItem('generalSettings', JSON.stringify(currentSettings));
        showMessage('Configuración guardada exitosamente', 'success');
        console.log('Configuración guardada:', currentSettings);
      } catch (error) {
        console.error('Error guardando configuración:', error);
        showMessage('Error al guardar la configuración', 'error');
      }
    }

    // Restaurar configuración predeterminada
    function resetSettings() {
      if (confirm('¿Está seguro de restaurar la configuración predeterminada?')) {
        currentSettings = { ...defaultSettings };
        updateUI();
        saveSettings();
        showMessage('Configuración restaurada a valores predeterminados', 'info');
      }
    }

    // Event Listeners - Theme Dropdown
    if (themeDropdown && themeMenu) {
      themeDropdown.addEventListener('click', () => toggleDropdown(themeMenu));
      
      themeMenu.querySelectorAll('.dropdown-item-custom').forEach(item => {
        item.addEventListener('click', (e) => {
          const value = (e.target as HTMLElement).dataset.value;
          if (value) {
            currentSettings.theme = value;
            updateUI();
            themeMenu.classList.add('d-none');
          }
        });
      });
    }

    // Event Listeners - Currency Dropdown
    if (currencyDropdown && currencyMenu) {
      currencyDropdown.addEventListener('click', () => toggleDropdown(currencyMenu));
      
      currencyMenu.querySelectorAll('.dropdown-item-custom').forEach(item => {
        item.addEventListener('click', (e) => {
          const value = (e.target as HTMLElement).dataset.value;
          if (value) {
            currentSettings.currency = value;
            updateUI();
            currencyMenu.classList.add('d-none');
          }
        });
      });
    }

    // Event Listener - Guardar
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', saveSettings);
    }

    // Event Listener - Restaurar
    if (resetSettingsBtn) {
      resetSettingsBtn.addEventListener('click', resetSettings);
    }

    // Cerrar dropdowns al hacer clic fuera
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('.dropdown-custom') && !target.closest('.dropdown-menu-custom')) {
        document.querySelectorAll('.dropdown-menu-custom').forEach(menu => {
          menu.classList.add('d-none');
        });
      }
    });

    // Cerrar dropdowns con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.dropdown-menu-custom').forEach(menu => {
          menu.classList.add('d-none');
        });
      }
    });

    // Inicializar
    loadSettings();
    console.log('Sistema de ajustes generales inicializado');
  });
</script>
