---
export const prerender = false;
import Layout from "../../../layouts/Layout.astro";
import LeftSidebar from "../../../components/LeftBar.astro";
import Navbar from "../../../components/Navbar.astro";
import ApexCharts from "apexcharts";



const response1 = await fetch("http://localhost:3484/api/purchases",{
    method: "GET",
    headers:{
      "Content-Type": "application/json",
    },
});

let json1 = null;
if (response1.ok) {
    json1 = await response1.json();
    console.log('Datos de compras:', json1.data);
} else {
    console.error("Error fetching data:", response1.statusText);
}

// Calcular estadísticas de compras
const compras = json1.data;
const totalGastado = compras.reduce((sum: number, compra: any) => sum + parseFloat(compra.total), 0);
const promedioCompras = totalGastado / compras.length;
const compraMasAlta = Math.max(...compras.map((compra: any) => parseFloat(compra.total)));
const compraMasBaja = Math.min(...compras.map((compra: any) => parseFloat(compra.total)));

// Preparar datos para el histograma
const montosCompras = compras.map((compra: any) => parseFloat(compra.total));
const fechasCompras = compras.map((compra: any) => new Date(compra.date).toLocaleDateString('es-ES'));
const proveedoresCompras = compras.map((compra: any) => compra.supplier.name);
---

<Layout title="Estadisticas de Gastos">
    <!-- Navbar en la parte superior -->
    <Navbar />
    
    <div class="d-flex">
        <!-- Sidebar a la izquierda -->
        <LeftSidebar 
            title="Resumen" 
            options={["Estadisticas de Ventas", "Estadisticas de Gastos", "Reporte de Ventas"]}
            selectedOption="Estadisticas de Gastos"  
        />
        <!-- Contenido principal dividido en dos columnas -->
        <div class="main-content-with-navbar-sidebar flex-grow-1 p-4">
            <div class="row">
                <!-- Columna izquierda: Gráficos y Tabla -->
                <div class="col-md-12">
                    <!-- CARDS DE ESTADÍSTICAS DE GASTOS -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0">
                                <div class="card-header text-white text-center py-3" style="background-color: #482E21;">
                                    <h5 class="mb-0">Total Gastado en Compras</h5>
                                </div>
                                <div class="card-body text-center py-4">
                                    <h2 class="fw-bold" style="color: #482E21;">
                                        ${totalGastado.toFixed(2)}
                                    </h2>
                                    <p class="text-muted mb-0">Monto total acumulado</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0">
                                <div class="card-header text-white text-center py-3" style="background-color: #482E21;">
                                    <h5 class="mb-0">Promedio por Compra</h5>
                                </div>
                                <div class="card-body text-center py-4">
                                    <h2 class="fw-bold" style="color: #482E21;">
                                        ${promedioCompras.toFixed(2)}
                                    </h2>
                                    <p class="text-muted mb-0">Valor promedio por transacción</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GRÁFICO DE HISTOGRAMA DE COMPRAS -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card shadow-sm">
                                <div class="card-header text-white text-center py-2" style="background-color: #482E21;">
                                    <h5 class="mb-0">Distribución de Compras por Monto</h5>
                                </div>
                                <div class="card-body p-3">
                                    <div id="histograma-compras"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <br/>
                    <!-- Tabla de Compras -->
                    <div class="mt-5">
                        <div class="card shadow-sm border-0" style="border-radius: 8px;">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead style="background-color: #482E21; color: white;">
                                            <tr>
                                                <th scope="col">ID Compra</th>
                                                <th scope="col">Fecha</th>
                                                <th scope="col">Proveedor</th>
                                                <th scope="col">Total</th>
                                                <th scope="col">Caja</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {compras.map((compra: any) => (
                                                <tr>
                                                    <th scope="row">{compra.purchaseId}</th>
                                                    <td>{new Date(compra.date).toLocaleDateString('es-ES')}</td>
                                                    <td>{compra.supplier.name}</td>
                                                    <td>${parseFloat(compra.total).toFixed(2)}</td>
                                                    <td>{compra.cashRegister}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Elementos ocultos para pasar datos -->
                    <div 
                        id="compras-data" 
                        data-montos={JSON.stringify(montosCompras)}
                        data-fechas={JSON.stringify(fechasCompras)}
                        data-proveedores={JSON.stringify(proveedoresCompras)}
                        style="display: none;"
                    ></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</Layout>

<style>
    /* Estilos específicos para la tabla que sobreescriben Bootstrap */
    .table th {
        font-weight: 600;
        font-size: 0.875rem;
        padding: 12px 16px;
    }

    .table td {
        padding: 12px 16px;
        vertical-align: middle;
    }

    .card {
        border-radius: 8px;
    }

    /* Ajustar altura de gráficos para que quepan en las cards */
    #histograma-compras {
        height: 400px !important;
    }

    /* Estilos para el fondo de las filas de la tabla */
    .table tbody tr {
        background-color: white;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Estilos para las cards de estadísticas */
    .card-body h2 {
        font-size: 2.5rem;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ========== HISTOGRAMA DE COMPRAS ==========
        const comprasDataElement = document.getElementById('compras-data');
        
        if (comprasDataElement) {
            const montosData = comprasDataElement.dataset.montos;
            const fechasData = comprasDataElement.dataset.fechas;
            const proveedoresData = comprasDataElement.dataset.proveedores;

            if (montosData && fechasData && proveedoresData) {
                const montos = JSON.parse(montosData);
                const fechas = JSON.parse(fechasData);
                const proveedores = JSON.parse(proveedoresData);

                // Crear histograma agrupando montos en rangos
                const histogramOptions = {
                  series: [{
                    name: 'Monto de Compra',
                    data: montos
                  }],
                  chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: {
                      show: true
                    }
                  },
                  plotOptions: {
                    bar: {
                      borderRadius: 4,
                      columnWidth: '60%',
                      dataLabels: {
                        position: 'top',
                      }
                    }
                  },
                  colors: ['#482E21'],
                  dataLabels: {
                    enabled: true,
                    formatter: function (val: number) {
                      return '$' + val.toFixed(0);
                    },
                    offsetY: -20,
                    style: {
                      fontSize: '12px',
                      colors: ['#304758']
                    }
                  },
                  xaxis: {
                    categories: fechas,
                    title: {
                      text: 'Fecha de Compra',
                      style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                      }
                    },
                    labels: {
                      rotate: -45,
                      rotateAlways: true,
                      style: {
                        fontSize: '10px'
                      }
                    }
                  },
                  yaxis: {
                    title: {
                      text: 'Monto ($)',
                      style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                      }
                    },
                    labels: {
                      formatter: function (val: number) {
                        return '$' + val.toFixed(0);
                      }
                    }
                  },
                  tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                      formatter: function (val: number) {
                        return '$' + val.toFixed(2);
                      }
                    },
                    custom: function({ dataPointIndex }: { dataPointIndex: number }) {
                      const monto = montos[dataPointIndex];
                      const fecha = fechas[dataPointIndex];
                      const proveedor = proveedores[dataPointIndex];
                      
                      return (
                        '<div class="p-2">' +
                        '<div><strong>Fecha:</strong> ' + fecha + '</div>' +
                        '<div><strong>Proveedor:</strong> ' + proveedor + '</div>' +
                        '<div><strong>Monto:</strong> $' + monto.toFixed(2) + '</div>' +
                        '</div>'
                      );
                    }
                  },
                  title: {
                    text: 'Distribución de Compras por Fecha',
                    align: 'center',
                    style: {
                      fontSize: '16px',
                      fontWeight: 'bold'
                    }
                  },
                  grid: {
                    borderColor: '#e7e7e7',
                    row: {
                      colors: ['#f3f3f3', 'transparent'],
                      opacity: 0.5
                    }
                  }
                };

                var histogramChart = new ApexCharts(document.querySelector("#histograma-compras"), histogramOptions);
                histogramChart.render();

                // Calcular estadísticas
                const totalGastadoClient = montos.reduce((sum: any, monto: any) => sum + monto, 0);
                const promedioComprasClient = totalGastadoClient / montos.length;
                const compraMasAltaClient = Math.max(...montos);
                const compraMasBajaClient = Math.min(...montos);

                // Mostrar estadísticas en consola
                console.log('=== ESTADÍSTICAS DE GASTOS ===');
                console.log('Total de compras:', montos.length);
                console.log('Total gastado: $' + totalGastadoClient.toFixed(2));
                console.log('Promedio por compra: $' + promedioComprasClient.toFixed(2));
                console.log('Compra más alta: $' + compraMasAltaClient.toFixed(2));
                console.log('Compra más baja: $' + compraMasBajaClient.toFixed(2));
                
                // Estadísticas por proveedor
                const gastosPorProveedor: { [key: string]: number } = {};
                montos.forEach((monto: number, index: number) => {
                  const proveedor = proveedores[index];
                  if (!gastosPorProveedor[proveedor]) {
                    gastosPorProveedor[proveedor] = 0;
                  }
                  gastosPorProveedor[proveedor] += monto;
                });
                
                console.log('=== GASTOS POR PROVEEDOR ===');
                Object.entries(gastosPorProveedor).forEach(([proveedor, total]) => {
                  console.log(proveedor + ': $' + total.toFixed(2));
                });
            }
        }
    });
</script>