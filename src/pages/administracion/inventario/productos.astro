---
import Layout from "../../../layouts/Layout.astro";
import Navbar from "../../../components/Navbar.astro";
import LeftBar from "../../../components/LeftBar.astro";

const sidebarOptions = ["Consumibles", "Productos", "Ingredientes", "Proveedores"];
---

<Layout>
    <div class="d-flex flex-column" style="min-height: 100vh;">
        <!-- Navbar que cubre toda la parte superior -->
        <Navbar />

        <div class="d-flex flex-grow-1">
            <!-- LeftBar debajo del Navbar -->
            <LeftBar title="Inventario" options={sidebarOptions} />

            <!-- Contenido principal -->
            <div class="flex-grow-1" style="background-color: #f8f9fa; font-family: 'Roboto', sans-serif;">
                <div class="p-4">
                    <!-- Botones en la esquina superior derecha -->
                    <div class="position-fixed" style="top: 100px; right: 40px; z-index: 1000;">
                        <div class="d-flex flex-column gap-3">
                            <button 
                                class="btn d-flex align-items-center justify-content-center gap-2" 
                                style="font-family: 'Roboto', sans-serif; border-radius: 8px; background-color: #482E21; color: white; border: 1px solid #482E21; width: 257px; height: 50px; font-size: 1.1rem;"
                                id="addProductBtn"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg>
                                Agregar Producto
                            </button>
                            <button 
                                class="btn d-flex align-items-center justify-content-center gap-2" 
                                style="font-family: 'Roboto', sans-serif; border-radius: 8px; background-color: #007bff; color: white; border: 1px solid #007bff; width: 257px; height: 50px; font-size: 1.1rem;"
                                id="updateProductBtn"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                </svg>
                                Actualizar
                            </button>
                            <button 
                                class="btn d-flex align-items-center justify-content-center gap-2" 
                                style="font-family: 'Roboto', sans-serif; border-radius: 8px; background-color: #930000; color: white; border: 1px solid #930000; width: 257px; height: 50px; font-size: 1.1rem;"
                                id="deleteProductBtn"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                                Eliminar
                            </button>
                        </div>
                    </div>

                    <div style="margin-right: 300px;">
                        <!-- Título Productos y campos -->
                        <div class="d-flex align-items-start">
                            <div style="width: 100%;">
                                <h1 class="h3 fw-bold mb-4" style="font-family: 'Roboto', sans-serif;">Productos</h1>

                                <!-- Primera fila de campos en horizontal -->
                                <div class="d-flex gap-4 mb-3">
                                    <!-- Campo ID -->
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-bold mb-2" style="font-family: 'Roboto', sans-serif;">ID</label>
                                        <input type="text" class="form-control search-input" id="searchId" style="font-family: 'Roboto', sans-serif; border-radius: 8px;" readonly />
                                    </div>

                                    <!-- Campo Nombre -->
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-bold mb-2" style="font-family: 'Roboto', sans-serif;">Nombre</label>
                                        <input type="text" class="form-control search-input" id="searchName" style="font-family: 'Roboto', sans-serif; border-radius: 8px;" />
                                    </div>

                                    <!-- Campo Tipo (select) -->
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-bold mb-2" style="font-family: 'Roboto', sans-serif;">Tipo</label>
                                        <select class="form-select search-input" id="searchType" style="font-family: 'Roboto', sans-serif; border-radius: 8px;">
                                            <option value="">Todos los tipos</option>
                                            <option>Bebidas</option>
                                            <option>Postres</option>
                                            <option>Snacks</option>
                                            <option>Especiales</option>
                                        </select>
                                    </div>

                                    <!-- Campo Costo -->
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-bold mb-2" style="font-family: 'Roboto', sans-serif;">Costo</label>
                                        <input type="text" class="form-control search-input" id="searchCost" style="font-family: 'Roboto', sans-serif; border-radius: 8px;" />
                                    </div>
                                </div>

                                <!-- Segunda fila de campos en horizontal -->
                                <div class="d-flex gap-4">
                                    <!-- Campo Precio Venta -->
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-bold mb-2" style="font-family: 'Roboto', sans-serif;">Precio Venta</label>
                                        <input type="text" class="form-control search-input" id="searchPrice" style="font-family: 'Roboto', sans-serif; border-radius: 8px;" />
                                    </div>

                                    <!-- Campo Ingredientes - CAMBIADO A "Buscar" -->
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-bold mb-2" style="font-family: 'Roboto', sans-serif;">Buscar</label>
                                        <input type="text" class="form-control search-input" id="searchIngredients" style="font-family: 'Roboto', sans-serif; border-radius: 8px;" placeholder="Buscar ingredientes" />
                                    </div>
                                </div>

                                <!-- Mensaje de estado -->
                                <div id="message" class="mt-3" style="display: none;"></div>

                                <!-- Tercera fila con botones Ordenar, Filtrar y Mostrar Inactivos -->
                                <div class="d-flex gap-4 mt-3 align-items-center">
                                    <div class="position-relative">
                                        <button class="btn mt-4 d-flex align-items-center gap-2 sort-toggle-btn" id="sortButton" style="font-family: 'Roboto', sans-serif; border-radius: 8px; background-color: #E6E6E6; border: 1px solid #E6E6E6;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                                            </svg>
                                            Ordenar
                                        </button>
                                        <!-- Menú desplegable de ordenamiento -->
                                        <div class="sort-dropdown-menu" id="sortDropdown" style="display: none; position: absolute; top: 100%; left: 0; z-index: 1000; min-width: 200px;">
                                            <div class="card shadow-sm border-0 mt-1">
                                                <div class="card-body p-2">
                                                    <h6 class="fw-bold mb-2">Ordenar por</h6>
                                                    <div class="sort-options">
                                                        <div class="sort-option" data-sort-by="id" data-sort-order="asc">
                                                            <span>ID (Ascendente)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="id" data-sort-order="desc">
                                                            <span>ID (Descendente)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="name" data-sort-order="asc">
                                                            <span>Nombre (A-Z)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="name" data-sort-order="desc">
                                                            <span>Nombre (Z-A)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="type" data-sort-order="asc">
                                                            <span>Tipo (A-Z)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="type" data-sort-order="desc">
                                                            <span>Tipo (Z-A)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="cost" data-sort-order="asc">
                                                            <span>Costo (Menor a Mayor)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="cost" data-sort-order="desc">
                                                            <span>Costo (Mayor a Menor)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="price" data-sort-order="asc">
                                                            <span>Precio (Menor a Mayor)</span>
                                                        </div>
                                                        <div class="sort-option" data-sort-by="price" data-sort-order="desc">
                                                            <span>Precio (Mayor a Menor)</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn mt-4 d-flex align-items-center gap-2" id="filterButton" style="font-family: 'Roboto', sans-serif; border-radius: 8px; background-color: #E6E6E6; border: 1px solid #E6E6E6;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
                                            </svg>
                                            Filtrar
                                        </button>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 mt-4">
                                        <span class="fw-bold" style="font-family: 'Roboto', sans-serif;">Mostrar Inactivos</span>
                                        <input type="checkbox" class="form-check-input" id="showInactive" style="border-radius: 50%;" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de productos -->
                        <div class="mt-5">
                            <div class="card shadow-sm border-0" style="border-radius: 8px;">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead style="background-color: #482E21; color: white;">
                                                <tr>
                                                    <th scope="col">ID</th>
                                                    <th scope="col">Nombre</th>
                                                    <th scope="col">Tipo</th>
                                                    <th scope="col">Costo</th>
                                                    <th scope="col">Precio venta</th>
                                                    <th scope="col">Ingredientes</th>
                                                    <th scope="col">Activo</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productsTableBody">
                                                <tr>
                                                    <td colspan="7" class="text-center">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Cargando productos...</span>
                                                        </div>
                                                        <div class="mt-2">Cargando productos...</div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mapa de rutas para la navegación del LeftBar
        const routeMap = {
            "Consumibles": "http://localhost:4321/administracion/inventario/consumibles",
            "Productos": "http://localhost:4321/administracion/inventario/productos", 
            "Ingredientes": "http://localhost:4321/administracion/inventario/ingredientes",
            "Proveedores": "http://localhost:4321/administracion/inventario/proveedores"
        };

        // Función para configurar la navegación del LeftBar
        function setupLeftBarNavigation() {
            console.log('Configurando navegación del LeftBar para Inventario...');
            
            // Primera pasada - buscar elementos por texto exacto
            setTimeout(() => {
                const options = ["Consumibles", "Productos", "Ingredientes", "Proveedores"];
                
                options.forEach(optionText => {
                    const elements = document.querySelectorAll('*');
                    elements.forEach(element => {
                        if (element.textContent && element.textContent.trim() === optionText && routeMap[optionText]) {
                            if (!element.hasAttribute('data-nav-configured')) {
                                element.style.cursor = 'pointer';
                                element.setAttribute('data-nav-configured', 'true');
                                
                                element.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const route = routeMap[optionText];
                                    console.log('Navegando a:', route);
                                    window.location.href = route;
                                });
                                
                                element.addEventListener('mouseenter', () => {
                                    element.style.backgroundColor = '#f8f9fa';
                                    element.style.transition = 'background-color 0.2s';
                                });
                                element.addEventListener('mouseleave', () => {
                                    element.style.backgroundColor = '';
                                });
                                
                                console.log('Configurado elemento para:', optionText);
                            }
                        }
                    });
                });
            }, 100);

            // Segunda pasada - buscar por selectores comunes
            setTimeout(() => {
                const sidebarSelectors = [
                    '.sidebar-item',
                    '.nav-link', 
                    '.list-group-item',
                    '[class*="option"]',
                    '[class*="item"]',
                    'a',
                    'button',
                    'div'
                ];
                
                sidebarSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(element => {
                        const text = element.textContent ? element.textContent.trim() : '';
                        if (text && text in routeMap) {
                            if (!element.hasAttribute('data-nav-configured')) {
                                element.style.cursor = 'pointer';
                                element.setAttribute('data-nav-configured', 'true');
                                element.addEventListener('click', () => {
                                    const route = routeMap[text];
                                    console.log('Navegando a:', route);
                                    window.location.href = route;
                                });
                                
                                element.addEventListener('mouseenter', () => {
                                    element.style.backgroundColor = '#f8f9fa';
                                });
                                element.addEventListener('mouseleave', () => {
                                    element.style.backgroundColor = '';
                                });
                            }
                        }
                    });
                });
            }, 200);

            // Tercera pasada - buscar en elementos específicos del LeftBar
            setTimeout(() => {
                // Buscar en elementos con clases comunes de sidebar
                const leftBarContainers = [
                    '.left-bar',
                    '.sidebar',
                    '.navigation',
                    '[class*="left"]',
                    '[class*="side"]'
                ];
                
                leftBarContainers.forEach(containerSelector => {
                    const containers = document.querySelectorAll(containerSelector);
                    containers.forEach(container => {
                        const links = container.querySelectorAll('a, button, div, span, li');
                        links.forEach(link => {
                            const text = link.textContent ? link.textContent.trim() : '';
                            if (text && text in routeMap && !link.hasAttribute('data-nav-configured')) {
                                link.style.cursor = 'pointer';
                                link.setAttribute('data-nav-configured', 'true');
                                link.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const route = routeMap[text];
                                    console.log('Navegando desde LeftBar a:', route);
                                    window.location.href = route;
                                });
                                
                                link.addEventListener('mouseenter', () => {
                                    link.style.backgroundColor = '#f8f9fa';
                                });
                                link.addEventListener('mouseleave', () => {
                                    link.style.backgroundColor = '';
                                });
                            }
                        });
                    });
                });
            }, 300);
        }

        // [Todo el resto del código de productos permanece igual...]
        // Variables globales para almacenar productos y configuraciones
        let allProducts = [];
        let selectedProductId = null;
        let currentFilteredProducts = [];
        let currentFilters = {
            id: '',
            name: '',
            type: '',
            cost: '',
            price: '',
            ingredients: '',
            showInactive: false
        };
        let currentSort = {
            by: 'id',
            order: 'asc'
        };
        let isSortVisible = false;

        // Elementos del DOM
        const addProductBtn = document.getElementById('addProductBtn');
        const updateProductBtn = document.getElementById('updateProductBtn');
        const deleteProductBtn = document.getElementById('deleteProductBtn');
        const message = document.getElementById('message');
        const productsTableBody = document.getElementById('productsTableBody');

        // Función para cargar productos desde tu API
        async function loadProducts() {
            try {
                console.log('Cargando productos desde API...');
                
                const response = await fetch("http://localhost:3484/api/products", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos recibidos del API:', data);
                    
                    let productsArray = data;
                    
                    if (!Array.isArray(data)) {
                        if (data.data && Array.isArray(data.data)) {
                            productsArray = data.data;
                        } else if (data.products && Array.isArray(data.products)) {
                            productsArray = data.products;
                        } else {
                            productsArray = [data];
                        }
                    }
                    
                    // Mapear los campos con detección de tipo
                    allProducts = productsArray.map(product => {
                        // Lógica para detectar el tipo basado en el nombre y descripción
                        let tipo = 'Bebidas'; // Por defecto bebidas
                        const nombreLower = product.name ? product.name.toLowerCase() : '';
                        const descLower = product.description ? product.description.toLowerCase() : '';
                        
                        if (nombreLower.includes('americano') || nombreLower.includes('espresso') || 
                            nombreLower.includes('café') || nombreLower.includes('coffee') ||
                            nombreLower.includes('latte') || nombreLower.includes('cappuccino') ||
                            nombreLower.includes('macchiato') || nombreLower.includes('chai') ||
                            nombreLower.includes('chocolate') || nombreLower.includes('cold') ||
                            nombreLower.includes('brew') || descLower.includes('café') || 
                            descLower.includes('coffee') || descLower.includes('espresso') ||
                            descLower.includes('agua') || descLower.includes('leche')) {
                            tipo = 'Bebidas';
                        } else if (nombreLower.includes('postre') || nombreLower.includes('cake') ||
                                  nombreLower.includes('cheesecake') || nombreLower.includes('dulce') ||
                                  nombreLower.includes('helado') || nombreLower.includes('flan')) {
                            tipo = 'Postres';
                        } else if (nombreLower.includes('snack') || nombreLower.includes('galleta') ||
                                  nombreLower.includes('cookie') || nombreLower.includes('pan')) {
                            tipo = 'Snacks';
                        } else if (nombreLower.includes('especial') || nombreLower.includes('premium') ||
                                  nombreLower.includes('exclusivo')) {
                            tipo = 'Especiales';
                        }
                        
                        return {
                            id: product.productId,
                            nombre: product.name,
                            tipo: tipo,
                            costo: product.cost,
                            precio_venta: product.price,
                            ingredientes: product.description || '',
                            activo: product.active
                        };
                    });
                    
                    console.log(`Se cargaron ${allProducts.length} productos`);
                    console.log('Tipos de productos encontrados:', [...new Set(allProducts.map(p => p.tipo))]);
                    
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                applyFiltersAndSort();
                
            } catch (error) {
                console.error('Error al cargar productos:', error);
                
                // Mostrar mensaje de error en la tabla
                if (productsTableBody) {
                    productsTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                <div>Error al cargar los productos</div>
                                <small>${error.message}</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary" onclick="loadProducts()">
                                        Reintentar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Función para aplicar filtros y ordenamiento
        function applyFiltersAndSort() {
            let filteredProducts = allProducts.filter(product => {
                // Usar los campos ya estandarizados
                const id = product.id.toString().toLowerCase();
                const nombre = product.nombre.toLowerCase();
                const tipo = product.tipo.toLowerCase();
                const costo = product.costo.toString().toLowerCase();
                const precioVenta = product.precio_venta.toString().toLowerCase();
                const ingredientes = product.ingredientes.toString().toLowerCase();
                const activo = product.activo;
                
                // Filtro por estado activo/inactivo
                if (!currentFilters.showInactive && !activo) {
                    return false;
                }
                
                // Filtro por ID
                if (currentFilters.id && !id.includes(currentFilters.id.toLowerCase())) {
                    return false;
                }
                
                // Filtro por Nombre
                if (currentFilters.name && !nombre.includes(currentFilters.name.toLowerCase())) {
                    return false;
                }
                
                // Filtro por Tipo
                if (currentFilters.type && tipo !== currentFilters.type.toLowerCase()) {
                    return false;
                }
                
                // Filtro por Costo
                if (currentFilters.cost && !costo.includes(currentFilters.cost.toLowerCase())) {
                    return false;
                }
                
                // Filtro por Precio
                if (currentFilters.price && !precioVenta.includes(currentFilters.price.toLowerCase())) {
                    return false;
                }
                
                // Filtro por Ingredientes
                if (currentFilters.ingredients && !ingredientes.includes(currentFilters.ingredients.toLowerCase())) {
                    return false;
                }
                
                return true;
            });

            // Aplicar ordenamiento
            filteredProducts = sortProducts(filteredProducts);
            
            // Actualizar productos filtrados
            currentFilteredProducts = filteredProducts;
            
            // Renderizar tabla
            renderProductsTable(filteredProducts);
        }

        // Función para ordenar productos
        function sortProducts(products) {
            return products.sort((a, b) => {
                let valueA, valueB;
                
                // Obtener valores según el campo a ordenar
                switch (currentSort.by) {
                    case 'id':
                        valueA = a.id;
                        valueB = b.id;
                        // Convertir a número si es posible
                        const numA = Number(valueA);
                        const numB = Number(valueB);
                        valueA = isNaN(numA) ? valueA.toString().toLowerCase() : numA;
                        valueB = isNaN(numB) ? valueB.toString().toLowerCase() : numB;
                        break;
                    case 'name':
                        valueA = a.nombre || '';
                        valueB = b.nombre || '';
                        valueA = valueA.toString().toLowerCase();
                        valueB = valueB.toString().toLowerCase();
                        break;
                    case 'type':
                        valueA = a.tipo || '';
                        valueB = b.tipo || '';
                        valueA = valueA.toString().toLowerCase();
                        valueB = valueB.toString().toLowerCase();
                        break;
                    case 'cost':
                        valueA = parseFloat(a.costo || 0);
                        valueB = parseFloat(b.costo || 0);
                        break;
                    case 'price':
                        valueA = parseFloat(a.precio_venta || 0);
                        valueB = parseFloat(b.precio_venta || 0);
                        break;
                    default:
                        valueA = a.id;
                        valueB = b.id;
                }
                
                // Aplicar orden ascendente o descendente
                if (currentSort.order === 'asc') {
                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                } else {
                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                }
            });
        }

        // Función para renderizar la tabla de productos
        function renderProductsTable(products) {
            if (!productsTableBody) {
                console.error('No se encontró el elemento productsTableBody');
                return;
            }
            
            if (!Array.isArray(products) || products.length === 0) {
                productsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            No se encontraron productos con los filtros aplicados
                        </td>
                    </tr>
                `;
                return;
            }
            
            productsTableBody.innerHTML = '';
            
            products.forEach(product => {
                // Usar los campos ya estandarizados
                const id = product.id;
                const nombre = product.nombre;
                const tipo = product.tipo;
                const costo = product.costo;
                const precioVenta = product.precio_venta;
                const activo = product.activo;
                
                const row = document.createElement('tr');
                row.setAttribute('data-product-id', id);
                row.innerHTML = `
                    <th scope="row">${id}</th>
                    <td>${nombre}</td>
                    <td>${tipo}</td>
                    <td>$${parseFloat(costo).toFixed(2)}</td>
                    <td>$${parseFloat(precioVenta).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm" style="background-color: #E6E6E6; border-radius: 8px;">
                            Ver ingredientes
                        </button>
                    </td>
                    <td>
                        <input type="checkbox" ${activo ? 'checked' : ''} class="form-check-input product-active" 
                               data-product-id="${id}" style="border-radius: 50%;" />
                    </td>
                `;
                productsTableBody.appendChild(row);
            });

            // Agregar event listeners a los checkboxes de activo
            addActiveCheckboxListeners();
        }

        // Función para agregar event listeners a los checkboxes de activo
        function addActiveCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.product-active');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const productId = this.getAttribute('data-product-id');
                    const isActive = this.checked;
                    
                    // Actualizar el estado en los datos
                    const product = allProducts.find(p => p.id == productId);
                    
                    if (product) {
                        product.activo = isActive;
                        console.log(`Producto ${productId} actualizado: activo = ${isActive}`);
                        
                        // Si no estamos mostrando inactivos y desactivamos un producto, recargar la tabla
                        if (!currentFilters.showInactive && !isActive) {
                            applyFiltersAndSort();
                        }
                    }
                });
            });
        }

        // Función para actualizar filtros desde los campos de búsqueda
        function updateFilters() {
            const searchId = document.getElementById('searchId');
            const searchName = document.getElementById('searchName');
            const searchType = document.getElementById('searchType');
            const searchCost = document.getElementById('searchCost');
            const searchPrice = document.getElementById('searchPrice');
            const searchIngredients = document.getElementById('searchIngredients');
            const showInactive = document.getElementById('showInactive');
            
            // Verificación de tipos para TypeScript
            currentFilters = {
                id: searchId && searchId instanceof HTMLInputElement ? searchId.value : '',
                name: searchName && searchName instanceof HTMLInputElement ? searchName.value : '',
                type: searchType && searchType instanceof HTMLSelectElement ? searchType.value : '',
                cost: searchCost && searchCost instanceof HTMLInputElement ? searchCost.value : '',
                price: searchPrice && searchPrice instanceof HTMLInputElement ? searchPrice.value : '',
                ingredients: searchIngredients && searchIngredients instanceof HTMLInputElement ? searchIngredients.value : '',
                showInactive: showInactive && showInactive instanceof HTMLInputElement ? showInactive.checked : false
            };
            
            console.log('Filtros actualizados:', currentFilters);
            applyFiltersAndSort();
        }

        // Función para toggle del menú de ordenamiento
        function toggleSortDropdown() {
            const sortDropdown = document.getElementById('sortDropdown');
            const sortButton = document.getElementById('sortButton');
            
            if (!sortDropdown || !sortButton) {
                console.warn('Elementos del menú de ordenamiento no encontrados');
                return;
            }
            
            isSortVisible = !isSortVisible;
            if (isSortVisible) {
                sortDropdown.style.display = 'block';
                sortButton.classList.add('active');
            } else {
                sortDropdown.style.display = 'none';
                sortButton.classList.remove('active');
            }
        }

        // Función para aplicar ordenamiento
        function applySort(sortBy, sortOrder) {
            currentSort.by = sortBy;
            currentSort.order = sortOrder;
            applyFiltersAndSort();
            toggleSortDropdown();
        }

        // Función para mostrar mensajes
        function showMessage(text, type) {
            if (!message) return;
            
            message.textContent = text;
            message.style.display = 'block';
            message.className = `alert alert-${type === 'success' ? 'success' : 'danger'} mt-3`;
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }

        // Función para limpiar formulario
        function clearForm() {
            const idInput = document.getElementById('searchId');
            const nameInput = document.getElementById('searchName');
            const typeInput = document.getElementById('searchType');
            const costInput = document.getElementById('searchCost');
            const priceInput = document.getElementById('searchPrice');
            const ingredientsInput = document.getElementById('searchIngredients');
            
            if (idInput && idInput instanceof HTMLInputElement) idInput.value = '';
            if (nameInput && nameInput instanceof HTMLInputElement) nameInput.value = '';
            if (typeInput && typeInput instanceof HTMLSelectElement) typeInput.value = '';
            if (costInput && costInput instanceof HTMLInputElement) costInput.value = '';
            if (priceInput && priceInput instanceof HTMLInputElement) priceInput.value = '';
            if (ingredientsInput && ingredientsInput instanceof HTMLInputElement) ingredientsInput.value = '';
        }

        // Función para limpiar selección
        function clearSelection() {
            selectedProductId = null;
            const allRows = document.querySelectorAll('#productsTableBody tr');
            allRows.forEach(row => {
                row.classList.remove('table-primary');
            });
        }

        // Función para cargar datos del producto en el formulario
        function loadProductData(productId) {
            console.log('Buscando producto con ID:', productId);
            
            const product = currentFilteredProducts.find(p => p.id == productId);
            
            if (!product) {
                console.error('Producto no encontrado con ID:', productId);
                showMessage('Error: No se pudo cargar los datos del producto', 'error');
                return;
            }

            const idInput = document.getElementById('searchId');
            const nameInput = document.getElementById('searchName');
            const typeInput = document.getElementById('searchType');
            const costInput = document.getElementById('searchCost');
            const priceInput = document.getElementById('searchPrice');
            const ingredientsInput = document.getElementById('searchIngredients');
            
            if (idInput && idInput instanceof HTMLInputElement) {
                idInput.value = product.id || '';
            }
            if (nameInput && nameInput instanceof HTMLInputElement) {
                nameInput.value = product.nombre || '';
            }
            if (typeInput && typeInput instanceof HTMLSelectElement) {
                typeInput.value = product.tipo || '';
            }
            if (costInput && costInput instanceof HTMLInputElement) {
                costInput.value = product.costo || '';
            }
            if (priceInput && priceInput instanceof HTMLInputElement) {
                priceInput.value = product.precio_venta || '';
            }
            if (ingredientsInput && ingredientsInput instanceof HTMLInputElement) {
                ingredientsInput.value = product.ingredientes || '';
            }

            console.log('Formulario llenado exitosamente para producto:', productId);
        }

        // Función para agregar nuevo producto
        async function addNewProduct() {
            const nameInput = document.getElementById('searchName');
            const typeInput = document.getElementById('searchType');
            const costInput = document.getElementById('searchCost');
            const priceInput = document.getElementById('searchPrice');
            const ingredientsInput = document.getElementById('searchIngredients');

            const name = nameInput && nameInput instanceof HTMLInputElement ? nameInput.value.trim() : '';
            const type = typeInput && typeInput instanceof HTMLSelectElement ? typeInput.value : '';
            const cost = costInput && costInput instanceof HTMLInputElement ? costInput.value.trim() : '';
            const price = priceInput && priceInput instanceof HTMLInputElement ? priceInput.value.trim() : '';
            const ingredients = ingredientsInput && ingredientsInput instanceof HTMLInputElement ? ingredientsInput.value.trim() : '';

            if (!name || !type || !cost || !price) {
                showMessage('Por favor complete todos los campos obligatorios', 'error');
                return;
            }

            try {
                const productData = {
                    name: name,
                    description: ingredients,
                    price: parseFloat(price),
                    cost: parseFloat(cost),
                    active: true
                };

                console.log('Enviando datos para agregar:', productData);

                const response = await fetch('http://localhost:3484/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Producto agregado exitosamente:', result);
                    showMessage('Producto agregado exitosamente', 'success');
                    clearForm();
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    console.error('Error al agregar producto:', errorData);
                    showMessage(`Error: ${errorData.message || 'No se pudo agregar el producto'}`, 'error');
                }
            } catch (error) {
                console.error('Error de red:', error);
                showMessage('Error de conexión. Verifique que el servidor esté funcionando.', 'error');
            }
        }

        // Función para actualizar producto
        async function updateProduct() {
            if (!selectedProductId) {
                showMessage('Por favor seleccione un producto de la tabla haciendo clic en la fila', 'error');
                return;
            }

            const nameInput = document.getElementById('searchName');
            const typeInput = document.getElementById('searchType');
            const costInput = document.getElementById('searchCost');
            const priceInput = document.getElementById('searchPrice');
            const ingredientsInput = document.getElementById('searchIngredients');

            const name = nameInput && nameInput instanceof HTMLInputElement ? nameInput.value.trim() : '';
            const type = typeInput && typeInput instanceof HTMLSelectElement ? typeInput.value : '';
            const cost = costInput && costInput instanceof HTMLInputElement ? costInput.value.trim() : '';
            const price = priceInput && priceInput instanceof HTMLInputElement ? priceInput.value.trim() : '';
            const ingredients = ingredientsInput && ingredientsInput instanceof HTMLInputElement ? ingredientsInput.value.trim() : '';

            if (!name || !type || !cost || !price) {
                showMessage('Por favor complete todos los campos obligatorios', 'error');
                return;
            }

            try {
                const productData = {
                    name: name,
                    description: ingredients,
                    price: parseFloat(price),
                    cost: parseFloat(cost),
                    active: true
                };

                console.log('Enviando datos para actualizar:', productData, 'ID:', selectedProductId);

                const response = await fetch(`http://localhost:3484/api/products/${selectedProductId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Producto actualizado exitosamente:', result);
                    showMessage('Producto actualizado exitosamente', 'success');
                    clearSelection();
                    clearForm();
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    console.error('Error al actualizar producto:', errorData);
                    showMessage(`Error: ${errorData.message || 'No se pudo actualizar el producto'}`, 'error');
                }
            } catch (error) {
                console.error('Error de red:', error);
                showMessage('Error de conexión. Verifique que el servidor esté funcionando.', 'error');
            }
        }

        // Función para eliminar producto
        async function deleteProduct() {
            if (!selectedProductId) {
                showMessage('Por favor seleccione un producto de la tabla haciendo clic en la fila', 'error');
                return;
            }

            if (!confirm('¿Está seguro de que desea eliminar este producto?')) {
                return;
            }

            try {
                console.log('Eliminando producto ID:', selectedProductId);

                const response = await fetch(`http://localhost:3484/api/products/${selectedProductId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    console.log('Producto eliminado exitosamente');
                    showMessage('Producto eliminado exitosamente', 'success');
                    clearSelection();
                    clearForm();
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    console.error('Error al eliminar producto:', errorData);
                    showMessage(`Error: ${errorData.message || 'No se pudo eliminar el producto'}`, 'error');
                }
            } catch (error) {
                console.error('Error de red:', error);
                showMessage('Error de conexión. Verifique que el servidor esté funcionando.', 'error');
            }
        }

        // Configurar selección de productos en la tabla
        let lastClickTime = 0;
        const DOUBLE_CLICK_DELAY = 300;

        function handleSingleClick(row) {
            const allRows = document.querySelectorAll('#productsTableBody tr');
            allRows.forEach(r => r.classList.remove('table-primary'));
            
            row.classList.add('table-primary');
            
            selectedProductId = row.getAttribute('data-product-id');
            
            console.log('Producto seleccionado (clic simple):', selectedProductId);
        }

        function handleDoubleClick(row) {
            const productId = row.getAttribute('data-product-id');
            if (!productId) return;

            console.log('Procesando doble clic para producto ID:', productId);
            
            handleSingleClick(row);
            
            loadProductData(productId);
            
            showMessage(`Datos del producto cargados en el formulario. Puede editarlos y hacer clic en "Actualizar".`, 'info');
            
            console.log('Formulario llenado automáticamente (doble clic) para producto:', productId);
        }

        // Inicializar event listeners cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando aplicación...');
            
            // Configurar navegación del LeftBar
            setupLeftBarNavigation();
            
            // Configuraciones adicionales para asegurar la navegación
            setTimeout(setupLeftBarNavigation, 500);
            setTimeout(setupLeftBarNavigation, 1000);
            setTimeout(setupLeftBarNavigation, 2000);

            // Cargar productos inicialmente
            loadProducts();
            
            // Configurar event listeners para los botones
            if (addProductBtn) {
                addProductBtn.addEventListener('click', addNewProduct);
            }

            if (updateProductBtn) {
                updateProductBtn.addEventListener('click', updateProduct);
            }

            if (deleteProductBtn) {
                deleteProductBtn.addEventListener('click', deleteProduct);
            }

            // Configurar selección de productos en la tabla
            if (productsTableBody) {
                productsTableBody.addEventListener('click', function(event) {
                    const target = event.target;
                    const row = target.closest('tr');
                    
                    if (row && row.getAttribute('data-product-id')) {
                        const currentTime = new Date().getTime();
                        const timeSinceLastClick = currentTime - lastClickTime;
                        
                        if (timeSinceLastClick < DOUBLE_CLICK_DELAY) {
                            console.log('Doble clic detectado en fila');
                            handleDoubleClick(row);
                        } else {
                            handleSingleClick(row);
                        }
                        
                        lastClickTime = currentTime;
                    }
                });
            }

            // Función para inicializar event listeners de forma segura
            function initializeEventListeners() {
                // Event listeners para campos de búsqueda
                const searchInputs = [
                    'searchId', 'searchName', 'searchType', 'searchCost', 'searchPrice', 'searchIngredients'
                ];
                
                searchInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', updateFilters);
                        input.addEventListener('change', updateFilters);
                        console.log(`Event listener agregado para: ${inputId}`);
                    } else {
                        console.warn(`Elemento con ID ${inputId} no encontrado`);
                    }
                });
                
                // Event listener para checkbox de inactivos
                const showInactiveCheckbox = document.getElementById('showInactive');
                if (showInactiveCheckbox && showInactiveCheckbox instanceof HTMLInputElement) {
                    showInactiveCheckbox.addEventListener('change', updateFilters);
                    console.log('Event listener agregado para showInactive');
                } else {
                    console.warn('Elemento con ID showInactive no encontrado o no es un input');
                }
                
                // Event listener para botón de ordenar
                const sortButton = document.getElementById('sortButton');
                if (sortButton) {
                    sortButton.addEventListener('click', toggleSortDropdown);
                    console.log('Event listener agregado para sortButton');
                } else {
                    console.warn('Elemento con ID sortButton no encontrado');
                }
                
                // Event listeners para opciones de ordenamiento
                const sortOptions = document.querySelectorAll('.sort-option');
                if (sortOptions.length > 0) {
                    sortOptions.forEach(option => {
                        option.addEventListener('click', function() {
                            const sortBy = this.getAttribute('data-sort-by');
                            const sortOrder = this.getAttribute('data-sort-order');
                            applySort(sortBy, sortOrder);
                        });
                    });
                    console.log(`Event listeners agregados para ${sortOptions.length} opciones de ordenamiento`);
                } else {
                    console.warn('Elementos con clase sort-option no encontrados');
                }
                
                // Event listener para botón de filtrar
                const filterButton = document.getElementById('filterButton');
                if (filterButton) {
                    filterButton.addEventListener('click', function() {
                        alert('Los filtros se aplican automáticamente mientras escribes en los campos de búsqueda');
                    });
                    console.log('Event listener agregado para filterButton');
                } else {
                    console.warn('Elemento con ID filterButton no encontrado');
                }
            }
            
            // Inicializar los event listeners
            initializeEventListeners();
            
            // Cerrar menú de ordenamiento al hacer clic fuera
            document.addEventListener('click', function(event) {
                const sortDropdown = document.getElementById('sortDropdown');
                const sortButton = document.getElementById('sortButton');
                
                if (isSortVisible && sortDropdown && sortButton && 
                    !sortDropdown.contains(event.target) && 
                    !sortButton.contains(event.target)) {
                    toggleSortDropdown();
                }
            });
        });

        // Configurar también cuando la ventana se carga completamente
        window.addEventListener('load', function() {
            console.log('Ventana cargada, verificando navegación de inventario...');
            setTimeout(setupLeftBarNavigation, 300);
        });
    </script>
</Layout>

<style>
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
    }

    .form-label {
        font-size: 1rem;
    }

    .form-check-input {
        margin-top: 0;
        border-radius: 50%;
    }

    .table th {
        font-weight: 600;
        font-size: 0.875rem;
        padding: 12px 16px;
    }

    .table td {
        padding: 12px 16px;
        vertical-align: middle;
    }

    .btn {
        border-radius: 8px;
    }

    .card {
        border-radius: 8px;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(72, 46, 33, 0.05);
        cursor: pointer;
    }

    .table-hover tbody tr.table-primary {
        background-color: #007bff !important;
        color: white;
    }

    .table-hover tbody tr.table-primary:hover {
        background-color: #0069d9 !important;
    }

    #searchId:read-only {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }

    .sort-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        min-width: 200px;
    }

    .sort-options {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .sort-option {
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.875rem;
    }

    .sort-option:hover {
        background-color: #e9ecef;
    }

    .sort-toggle-btn.active {
        background-color: #482E21 !important;
        color: white !important;
        border-color: #482E21 !important;
    }

    /* Estilos para elementos navegables del LeftBar */
    [data-nav-configured="true"] {
        cursor: pointer !important;
        transition: background-color 0.2s ease;
    }

    [data-nav-configured="true"]:hover {
        background-color: #f8f9fa !important;
    }
</style>