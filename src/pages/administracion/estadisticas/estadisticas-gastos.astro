---
export const prerender = false;
import Layout from "../../../layouts/Layout.astro";
import LeftSidebar from "../../../components/LeftBar.astro";
import Navbar from "../../../components/Navbar.astro";
import ApexCharts from "apexcharts";
import { BACKEND_API_URL } from "../../../config/api";

const estadisticasRouteMap: Record<string, string> = {
    "Estadisticas de Ventas": "/administracion/estadisticas/estadisticas-ventas",
    "Estadisticas de Gastos": "/administracion/estadisticas/estadisticas-gastos",
    "Reporte de Ventas": "/administracion/estadisticas/reporte-ventas"
};

const json1 = {
    data: [
        { purchaseId: "COMP-001", date: "2024-01-10", supplier: { name: "Proveedor A" }, total: "1250.50", cashRegister: "Caja 1" },
        { purchaseId: "COMP-002", date: "2024-01-11", supplier: { name: "Proveedor B" }, total: "890.75", cashRegister: "Caja 2" },
        { purchaseId: "COMP-003", date: "2024-01-12", supplier: { name: "Proveedor A" }, total: "1560.20", cashRegister: "Caja 1" },
        { purchaseId: "COMP-004", date: "2024-01-13", supplier: { name: "Proveedor C" }, total: "2034.40", cashRegister: "Caja 3" },
        { purchaseId: "COMP-005", date: "2024-01-14", supplier: { name: "Proveedor B" }, total: "780.90", cashRegister: "Caja 2" },
        { purchaseId: "COMP-006", date: "2024-01-15", supplier: { name: "Proveedor D" }, total: "1456.60", cashRegister: "Caja 1" },
        { purchaseId: "COMP-007", date: "2024-01-16", supplier: { name: "Proveedor A" }, total: "1893.30", cashRegister: "Caja 3" },
        { purchaseId: "COMP-008", date: "2024-01-17", supplier: { name: "Proveedor C" }, total: "952.25", cashRegister: "Caja 2" },
        { purchaseId: "COMP-009", date: "2024-01-18", supplier: { name: "Proveedor D" }, total: "1678.80", cashRegister: "Caja 1" },
        { purchaseId: "COMP-010", date: "2024-01-19", supplier: { name: "Proveedor B" }, total: "1345.45", cashRegister: "Caja 3" }
    ]
};

const compras = json1.data;
const totalGastado = compras.reduce((sum: number, compra: any) => sum + parseFloat(compra.total), 0);
const promedioCompras = totalGastado / compras.length;
const compraMasAlta = Math.max(...compras.map((compra: any) => parseFloat(compra.total)));
const compraMasBaja = Math.min(...compras.map((compra: any) => parseFloat(compra.total)));

const montosCompras = compras.map((compra: any) => parseFloat(compra.total));
const fechasCompras = compras.map((compra: any) => new Date(compra.date).toLocaleDateString('es-ES'));
const proveedoresCompras = compras.map((compra: any) => compra.supplier.name);
---

<Layout title="Estadisticas de Gastos">
    <Navbar />
    
    <div class="d-flex">
        <LeftSidebar 
            title="Resumen" 
            options={["Estadisticas de Ventas", "Estadisticas de Gastos", "Reporte de Ventas"]}
            selectedOption="Estadisticas de Gastos"
            routeMap={estadisticasRouteMap}
        />
        <div class="main-content-with-navbar-sidebar flex-grow-1 p-4">
            <div class="row">
                <div class="col-md-12">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0">
                                <div class="card-header text-white text-center py-3" style="background-color: #482E21;">
                                    <h5 class="mb-0">Total Gastado en Compras</h5>
                                </div>
                                <div class="card-body text-center py-4">
                                    <h2 class="fw-bold" style="color: #482E21;">
                                        ${totalGastado.toFixed(2)}
                                    </h2>
                                    <p class="text-muted mb-0">Monto total acumulado</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0">
                                <div class="card-header text-white text-center py-3" style="background-color: #482E21;">
                                    <h5 class="mb-0">Promedio por Compra</h5>
                                </div>
                                <div class="card-body text-center py-4">
                                    <h2 class="fw-bold" style="color: #482E21;">
                                        ${promedioCompras.toFixed(2)}
                                    </h2>
                                    <p class="text-muted mb-0">Valor promedio por transacción</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card shadow-sm">
                                <div class="card-header text-white text-center py-2" style="background-color: #482E21;">
                                    <h5 class="mb-0">Distribución de Compras por Monto</h5>
                                </div>
                                <div class="card-body p-3">
                                    <div id="histograma-compras"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <br/>
                    <div class="mt-5">
                        <div class="card shadow-sm border-0" style="border-radius: 8px;">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead style="background-color: #482E21; color: white;">
                                            <tr>
                                                <th scope="col">ID Compra</th>
                                                <th scope="col">Fecha</th>
                                                <th scope="col">Proveedor</th>
                                                <th scope="col">Total</th>
                                                <th scope="col">Caja</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {compras.map((compra: any) => (
                                                <tr>
                                                    <th scope="row">{compra.purchaseId}</th>
                                                    <td>{new Date(compra.date).toLocaleDateString('es-ES')}</td>
                                                    <td>{compra.supplier.name}</td>
                                                    <td>${parseFloat(compra.total).toFixed(2)}</td>
                                                    <td>{compra.cashRegister}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div 
                        id="compras-data" 
                        data-montos={JSON.stringify(montosCompras)}
                        data-fechas={JSON.stringify(fechasCompras)}
                        data-proveedores={JSON.stringify(proveedoresCompras)}
                        style="display: none;"
                    ></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
    const routeMap: Record<string, string> = {
        "Estadisticas de Ventas": "http://localhost:4321/administracion/estadisticas/estadisticas-ventas",
        "Estadisticas de Gastos": "http://localhost:4321/administracion/estadisticas/estadisticas-gastos", 
        "Reporte de Ventas": "http://localhost:4321/administracion/estadisticas/reporte-ventas"
    };

    function setupLeftBarNavigation() {
        setTimeout(() => {
            const sidebarItems = document.querySelectorAll('.sidebar-item, .nav-link, .list-group-item, [class*="option"], [class*="item"]');
            
            sidebarItems.forEach(item => {
                const text = item.textContent?.trim();
                if (text && text in routeMap) {
                    (item as HTMLElement).style.cursor = 'pointer';
                    item.addEventListener('click', () => {
                        console.log('Navegando a:', routeMap[text]);
                        window.location.href = routeMap[text];
                    });
                    
                    item.addEventListener('mouseenter', () => {
                        (item as HTMLElement).style.backgroundColor = '#f8f9fa';
                        (item as HTMLElement).style.transition = 'background-color 0.2s';
                    });
                    item.addEventListener('mouseleave', () => {
                        (item as HTMLElement).style.backgroundColor = '';
                    });
                }
            });
            
            console.log('Navegación del LeftBar configurada - Método 1');
        }, 100);
    }

    function setupLeftBarNavigationAlternative() {
        setTimeout(() => {
            const options = ["Estadisticas de Ventas", "Estadisticas de Gastos", "Reporte de Ventas"];
            
            options.forEach(optionText => {
                const elements = document.querySelectorAll('*');
                elements.forEach(element => {
                    if (element.textContent?.trim() === optionText && routeMap[optionText]) {
                        if (!element.hasAttribute('data-nav-configured')) {
                            (element as HTMLElement).style.cursor = 'pointer';
                            element.setAttribute('data-nav-configured', 'true');
                            
                            element.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Navegando a:', routeMap[optionText]);
                                window.location.href = routeMap[optionText];
                            });
                            
                            element.addEventListener('mouseenter', () => {
                                (element as HTMLElement).style.backgroundColor = '#f8f9fa';
                                (element as HTMLElement).style.transition = 'background-color 0.2s';
                            });
                            element.addEventListener('mouseleave', () => {
                                (element as HTMLElement).style.backgroundColor = '';
                            });
                        }
                    }
                });
            });
            
            console.log('Navegación del LeftBar configurada - Método 2');
        }, 200);
    }

    function setupLeftBarNavigationAggressive() {
        setTimeout(() => {
            const options = ["Estadisticas de Ventas", "Estadisticas de Gastos", "Reporte de Ventas"];
            
            const possibleContainers = document.querySelectorAll('div, span, a, li, p, button, label');
            
            possibleContainers.forEach(container => {
                const text = container.textContent?.trim();
                if (text && options.includes(text) && text in routeMap) {
                    if (!container.hasAttribute('data-nav-configured')) {
                        (container as HTMLElement).style.cursor = 'pointer';
                        container.setAttribute('data-nav-configured', 'true');
                        
                        container.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Navegando a:', routeMap[text]);
                            window.location.href = routeMap[text];
                        });
                        
                        container.addEventListener('mouseenter', () => {
                            (container as HTMLElement).style.backgroundColor = '#f8f9fa';
                        });
                        container.addEventListener('mouseleave', () => {
                            (container as HTMLElement).style.backgroundColor = '';
                        });
                    }
                }
            });
            
            console.log('Navegación del LeftBar configurada - Método 3');
        }, 300);
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupLeftBarNavigation();
        setTimeout(setupLeftBarNavigationAlternative, 500);
        setTimeout(setupLeftBarNavigationAggressive, 1000);
    });
    </script>
</Layout>

<style>
    .table th {
        font-weight: 600;
        font-size: 0.875rem;
        padding: 12px 16px;
    }

    .table td {
        padding: 12px 16px;
        vertical-align: middle;
    }

    .card {
        border-radius: 8px;
    }

    #histograma-compras {
        height: 400px !important;
    }

    .table tbody tr {
        background-color: white;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .card-body h2 {
        font-size: 2.5rem;
    }

    [class*="sidebar"] [class*="item"],
    [class*="nav"] [class*="link"],
    [class*="list"] [class*="item"] {
        transition: background-color 0.2s ease;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const comprasDataElement = document.getElementById('compras-data');
        
        if (comprasDataElement) {
            const montosData = comprasDataElement.dataset.montos;
            const fechasData = comprasDataElement.dataset.fechas;
            const proveedoresData = comprasDataElement.dataset.proveedores;

            if (montosData && fechasData && proveedoresData) {
                const montos = JSON.parse(montosData);
                const fechas = JSON.parse(fechasData);
                const proveedores = JSON.parse(proveedoresData);

                const histogramOptions = {
                  series: [{
                    name: 'Monto de Compra',
                    data: montos
                  }],
                  chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: {
                      show: true
                    }
                  },
                  plotOptions: {
                    bar: {
                      borderRadius: 4,
                      columnWidth: '60%',
                      dataLabels: {
                        position: 'top',
                      }
                    }
                  },
                  colors: ['#482E21'],
                  dataLabels: {
                    enabled: true,
                    formatter: function (val: number) {
                      return '$' + val.toFixed(0);
                    },
                    offsetY: -20,
                    style: {
                      fontSize: '12px',
                      colors: ['#304758']
                    }
                  },
                  xaxis: {
                    categories: fechas,
                    title: {
                      text: 'Fecha de Compra',
                      style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                      }
                    },
                    labels: {
                      rotate: -45,
                      rotateAlways: true,
                      style: {
                        fontSize: '10px'
                      }
                    }
                  },
                  yaxis: {
                    title: {
                      text: 'Monto ($)',
                      style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                      }
                    },
                    labels: {
                      formatter: function (val: number) {
                        return '$' + val.toFixed(0);
                      }
                    }
                  },
                  tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                      formatter: function (val: number) {
                        return '$' + val.toFixed(2);
                      }
                    },
                    custom: function({ dataPointIndex }: { dataPointIndex: number }) {
                      const monto = montos[dataPointIndex];
                      const fecha = fechas[dataPointIndex];
                      const proveedor = proveedores[dataPointIndex];
                      
                      return (
                        '<div class="p-2">' +
                        '<div><strong>Fecha:</strong> ' + fecha + '</div>' +
                        '<div><strong>Proveedor:</strong> ' + proveedor + '</div>' +
                        '<div><strong>Monto:</strong> $' + monto.toFixed(2) + '</div>' +
                        '</div>'
                      );
                    }
                  },
                  title: {
                    text: 'Distribución de Compras por Fecha',
                    align: 'center',
                    style: {
                      fontSize: '16px',
                      fontWeight: 'bold'
                    }
                  },
                  grid: {
                    borderColor: '#e7e7e7',
                    row: {
                      colors: ['#f3f3f3', 'transparent'],
                      opacity: 0.5
                    }
                  }
                };

                var histogramChart = new ApexCharts(document.querySelector("#histograma-compras"), histogramOptions);
                histogramChart.render();
            }
        }
    });
</script>